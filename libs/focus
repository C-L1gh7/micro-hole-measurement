import cv2
import glob
import os

def compute_focus_measure(gray_image):
    """使用Laplacian方差作为聚焦度指标"""
    lap = cv2.Laplacian(gray_image, cv2.CV_64F)
    return lap.var()

def find_sharpest_image(input_dir="photo"):
    """读取灰度图像序列并输出聚焦度最好的图像编号"""
    img_paths = glob.glob(f"{input_dir}/**/processed/gray/*.png", recursive=True)
    if not img_paths:
        print(f"未找到 {input_dir} 目录下的图片！")
        return

    for img_path in img_paths:
        img = cv2.imread(img_path)
        if img is None:
            print(f"无法读取图片: {img_path}")
            continue

    best_index = -1
    max_focus_value = -1

    for i, path in enumerate(img_paths):
        img = cv2.imread(path, cv2.IMREAD_GRAYSCALE)
        if img is None:
            print(f"无法读取图像: {path}")
            continue

        focus_value = compute_focus_measure(img)

        print(f"图像 {i} - 聚焦度: {focus_value:.2f}")

        if focus_value > max_focus_value:
            max_focus_value = focus_value
            best_index = i

    print(f"\n聚焦度最高的图像编号是: {best_index}")
    print(f"路径为: {img_paths[best_index]}")
    return best_index, img_paths[best_index]

# 调用函数
if __name__ == "__main__":
    find_sharpest_image()
