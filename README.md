# Micro Hole Measurement

## 项目简介

本项目基于 **SFF（Shape from Focus）方法**，用于测量大深径比微孔的参数。实验室测量时，最小精度可稳定在小数点后三位（单位：mm），但精度受环境因素影响较大。项目算法源码位于 `libs` 文件夹，最终赛场仅使用了 `shot.py` 和 `focus_analysis.py`，未采用 B 站发布的 GDANS 算法。孔径计算采用经典的**边缘识别 + 最小二乘法拟合圆**方法。该算法可在约 34 秒内完成一个样品的测量，若测量时间明显偏离，建议检查运行环境。

---

## 环境要求

- **Python**：3.8.5
- **单片机**：STM32F103C8

---

## 主要硬件

- 同轴光显微镜 + 5 倍金相镜头
- 电动位移平台 + 驱动板
- 单片机
- 笔记本电脑

---

## 算法原理

1. **自动拍照**  
    通过电动位移平台控制显微镜移动，等间隔拍照。

2. **上位机控制**  
    - 使用 OpenCV 监视 CMOS 画面。
    - 按键操作：
      - `1`/`2`：前进/后退
      - `3`/`4`：大步长前进/后退
      - 调整焦平面至略靠前于上表面后，按 `s` 开始自动拍摄，平台自动移动。
      - 遍历上表面后，按 `k` 停止记录数据（防止数据过多拖慢计算）。
      - 焦平面移动至略靠前于底面后，再次按 `k` 开始记录。
      - 遍历底面后，按 `s` 停止记录，按 `q` 退出监视，程序开始计算孔深。

3. **数据处理**  
    - 程序通过聚焦度计算 + 偏态高斯拟合，自动选取上、下表面最佳聚焦照片。
    - 聚焦度最好的前后 2 张（共 5 张）通过企业微信机器人自动发送给负责处理孔径的同学（需配置自己的机器人 key）。
    - 捕获画面存储于 `photos/时间戳` 文件夹。

---

## 文件结构

```
micro-hole-measurement/
├── libs/                  # 算法源码（主要用 shot.py 和 focus_analysis.py）
├── photos/                # 拍摄图片存储目录
├── README.md              # 项目说明文档
└── SingleChip             # 单片机源码
```

---

## 注意事项

- 精度受环境影响较大，建议在稳定环境下测量。
- 若测量速度异常，请检查硬件连接和软件配置。
- 企业微信机器人需自行配置 key。

---

## 联系方式

如有疑问或建议，欢迎通过 Issues 或邮件联系项目维护者。

感谢大家的支持，免费分享，大家的Star就是对我最大的鼓励
